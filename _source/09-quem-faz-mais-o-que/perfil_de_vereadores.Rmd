
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Perfil de vereadores

```{r, echo=FALSE, include=FALSE}
library(knitr)
current_dir = getwd()
setwd(Sys.getenv("VEREADOR_DIR"))
source("server.R")
source("vereadores_logic.R")
setwd(current_dir)

ementas = get_ementas_all(start_camara_db())

# library(ggiraph)
# library(ggplot2)
# library(ggiraphExtra)
# #source("ggRadar2.R")

# library(grid)
# library(gridExtra)
# library(ggradar)

library(fmsb)
library(highcharter)

```

```{r, fig.height=3, fig.width=10, echo=FALSE, warning=FALSE, message=FALSE}
simpleCap <- function(x) {
    s <- strsplit(x, " ")[[1]]
    paste(toupper(substring(s, 1, 1)),
          tolower(substring(s, 2)),
          sep = "",
          collapse = " ")
  }

get_vereadores_para_ui = function(db) {
  vereadores = get_vereadores(db) %>%
    mutate(eleito = ifelse(grepl("^ELEITO", desc_sit_tot_turno),
                           "Eleito",
                           "Suplente"),
           sexo = descricao_sexo)

  vereadores = vereadores %>%
    mutate_at(vars(matches("nome|desc|sexo")), function(x)
      sapply(x, simpleCap))

  return(vereadores)
}


camara_db <- start_camara_db()
vereadores = get_vereadores_para_ui(camara_db)
ementas = get_ementas_all(camara_db, not_older_than = 2013)

epv = data.frame() # Ementas por vereador
for (v in vereadores$sequencial_candidato) {
  desse_vereador = get_ementas_por_vereador(camara_db, v, 2012)
  epv = rbind(epv, desse_vereador)
}
epv = epv %>% filter(proponents != "Romero Rodrigues Veiga")
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
atos.tema.legislativo = epv %>% 
  subset(tipo_ato == "Legislativo" & !grepl("DENOMINA DE.*RUA|CONCEDE MEDALHA|TÍTULO DE CID", title)) %>%
  mutate(nome_urna_candidato = sapply(nome_urna_candidato, simpleCap)) %>% 
  left_join(select(vereadores, nome_urna_candidato),
            by = c("nome_urna_candidato")) %>% 
  rename(Vereador = nome_urna_candidato) %>% 
  group_by(Vereador) %>% 
  summarise(Administração = as.numeric(sum(main_theme == "administração")), 
            Agricultura = as.numeric(sum(main_theme == "agricultura")), 
            `Assistência Social` = as.numeric(sum(main_theme == "assistencia social")),
            `Educação e Cultura` = as.numeric(sum(main_theme == "educação e cultura")),
            `Gestão e Finanças` = as.numeric(sum(main_theme == "gestão e finanças")),
            Mobilidade = as.numeric(sum(main_theme == "mobilidade")),
            `Obras e Infr. Física` = as.numeric(sum(main_theme == "obras e infraestrutura física")),
            Saúde = as.numeric(sum(main_theme == "saúde")),
            `Segurança e Meio Amb.` = as.numeric(sum(main_theme == "segurança e meio ambiente")),
            Outros = as.numeric(sum(main_theme == "outros")))

atividade.vereador = data.frame(Vereador=atos.tema.legislativo$Vereador, n=rowSums(atos.tema.legislativo[,2:NCOL(atos.tema.legislativo)]))

atos.legis.relativo = atos.tema.legislativo[, 2:11]/rowSums(atos.tema.legislativo[, 2:11])
atos.legis.relativo = cbind(Vereador = atos.tema.legislativo$Vereador, atos.legis.relativo)
atos.legis.relativo = cbind(atos.legis.relativo, ordem = rowSums(atos.legis.relativo[,2:11]* atos.legis.relativo[,2:11]))
atos.legis.relativo=rbind(rep(1,12) , rep(0,12), atos.legis.relativo)

#teste = data.frame( tipo = c("tipo1", "tipo2"), um = c(0.6, 0.3), dois=c(0.9,0.2), tres=c(0.5, 0.3), quatro = c(0.8, 0.5), todo =c(0, 1))
#ggradar(teste)

```



## Propostas legislativas, desconsiderando nomes, medalhas e títulos (valores relativos)

### Como interpretar os gráficos

Logo abaixo temos três exemplos de como podemos interpretar os gráficos de perfis.

```{r, fig.height=3, fig.width=10, echo=FALSE, warning=FALSE, message=FALSE}

tutorial.chart = atos.legis.relativo[1:2, 2:NCOL(atos.legis.relativo)]
tutorial.chart = rbind(tutorial.chart, rep(0,10), c(0, 0, 0, 0, 1, 0, 0, 0, 0, 0), c(0.25, 0, 0, 0.5, 0, 0,0.25, 0, 0, 0) ,rep(0.0,10))

colors_border=c(rgb(0.8,0.2,0.5,0.9) , rgb(0.8,0.2,0.5,0.9))
colors_in=c( rgb(0.8,0.2,0.5,0.4) , rgb(0.8,0.2,0.5,0.9))

par(mar=c(3,0,3,0))
    par(mfrow=c(1,3))

for(i in 3:5){
  radarchart(tutorial.chart[c(1,2,i,6),], axistype=1,
                 pcol=colors_border , pfcol=colors_in, plwd=1, pty=c(16,32), plty=1,
                  axislabcol="grey" , caxislabels=seq(0,100,25), cglcol = "grey80", cglty=1, cglwd=0.8, title = paste("Exemplo", i-2, sep=" ") , vlcex=0.8 )
}
```

* O Exemplo 1 ilustra a situação em que um vereador não teve propostas aprovadas em nenhuma das categorias. Repare que todos os pontos se concentram no marco zero.
* O Exemplo 2 ilustra a situação em que um vereador teve todas as suas propostas aprovadas em apenas uma área. Repare que o ponto da categoria Gestão e Finanças atinge o valor 100% no gráfico, enquanto todos os outros permanecem no marco zero.
* O Exemplo 3 ilustra a situação em que um vereador teve propostas aprovadas em diferentes categorias. Podemos notar no exemplo que 50% foram em Educação e Cultura, 25% em Administração, os outros 25% restantes em Obras e Infr. Física e os pontos das demais categorias se encontram no marco zero.

#### Atividade alta (#propostas >= 80)

```{r, fig.height=14, fig.width=16, echo=FALSE, warning=FALSE, message=FALSE}

# fig.height=14, fig.width=16... 6x16



 #     myList = list()
 #     j = 0
 # for (i in as.numeric(row.names(atividade.vereador[atividade.vereador$n>=80,]))){
 #     atual.vereador = atos.legis.relativo[i+2,]
 #     j = j+1
 #    
 #    p = ggradar(atual.vereador, group.point.size = 4,  axis.label.size = 5, grid.label.size = 4, axis.label.offset = 0.8, grid.line.width = 0.5, gridline.min.linetype = "twodash", gridline.mid.linetype = "dotted", gridline.max.linetype = "twodash", legend.text.size = 3, gridline.mid.colour = "#007A87") + labs(title=atos.legis.relativo$Vereador[i+2]) + theme(legend.position="none", plot.title = element_text(size=20)) 
 # 
 #    myList[[j]] = p
 # 
 # }
 #     do.call(grid.arrange, c(myList, list(ncol=2)))

```

```{r, fig.height=3, fig.width=10, echo=FALSE, warning=FALSE, message=FALSE}
 
#fig.height=77, fig.width=16
    
 #          myList = list()
 #     j = 0
 # for (i in as.numeric(row.names(atividade.vereador[atividade.vereador$n<35,]))){
 #     atual.vereador = atos.legis.relativo[i+2,]
 #     j = j+1
 # 
 #    p = ggradar(atual.vereador, group.point.size = 4,  axis.label.size = 5, grid.label.size = 4, axis.label.offset = 0.8, grid.line.width = 0.5, gridline.min.linetype = "twodash", gridline.mid.linetype = "dotted", gridline.max.linetype = "twodash", legend.text.size = 3, gridline.mid.colour = "#007A87") + labs(title=atos.legis.relativo$Vereador[i+2]) + theme(legend.position="none", plot.title = element_text(size=20))
 # 
 #    myList[[j]] = p
 # 
 # }
 #     do.call(grid.arrange, c(myList, list(ncol=2)))

    

colors_border=c(rgb(0.7,0.5,0.1,0.9) , rgb(0.7,0.5,0.1,0.9))
colors_in=c( rgb(0.7,0.5,0.1,0.4) , rgb(0.7,0.5,0.1,0.9))

 par(mar=c(3,0,3,0))
    par(mfrow=c(1,3))

selection = atos.legis.relativo[as.numeric(row.names(atividade.vereador[atividade.vereador$n>=80,]))+2,]

        
for (i in order(selection[,12])){
    atual.vereador = rbind(rep(1,11), rep(0,11), selection[i,2:11], rep(0,11))

    radarchart(atual.vereador, axistype=1,
               pcol=colors_border , pfcol=colors_in, plwd=1, pty=c(16,32), plty=1,
                axislabcol="grey" , caxislabels=seq(0,100,25), cglcol = "grey80", cglty=1, cglwd=0.8,
                title =  selection[i,1], vlcex=0.8 )
}
```


#### Atividade média (35 <= #prospostas < 80)

```{r, fig.height=3, fig.width=10, echo=FALSE, warning=FALSE, message=FALSE}
par(mar=c(3,0,3,0))
    par(mfrow=c(1,3))

selection = atos.legis.relativo[as.numeric(row.names(atividade.vereador[atividade.vereador$n<80 & atividade.vereador$n>=35,]))+2,]

for (i in order(selection[,12])){
    atual.vereador = rbind(rep(1,11), rep(0,11), selection[i,2:11], rep(0,11))

    radarchart(atual.vereador, axistype=1,
               pcol=colors_border , pfcol=colors_in, plwd=1, pty=c(16,32), plty=1,
                axislabcol="grey" , caxislabels=seq(0,100,25), cglcol = "grey80", cglty=1, cglwd=0.8,
                title =  selection[i,1], vlcex=0.8 )

}
```

#### Atividade baixa ( #propostas < 35)

```{r, fig.height=3, fig.width=10, echo=FALSE, warning=FALSE, message=FALSE}
par(mar=c(3,0,3,0))
    par(mfrow=c(1,3))
    
selection = atos.legis.relativo[as.numeric(row.names(atividade.vereador[atividade.vereador$n<35,]))+2,]

for (i in order(selection[,12])){
    atual.vereador = rbind(rep(1,11), rep(0,11), selection[i,2:11], rep(0,11))

    radarchart(atual.vereador, axistype=1,
               pcol=colors_border , pfcol=colors_in, plwd=1, pty=c(16,32), plty=1,
                axislabcol="grey" , caxislabels=seq(0,100,25), cglcol = "grey80", cglty=1, cglwd=0.8,
                title =  selection[i,1], vlcex=0.8 )

}
```

```{r, fig.height=3, fig.width=10, echo=FALSE, warning=FALSE, message=FALSE}

# atos.legis.relativo = atos.tema.legislativo[, 2:11]/rowSums(atos.tema.legislativo[, 2:11])
# 
# atos.legis.relativo = cbind(Vereador = atos.tema.legislativo$Vereador, atos.legis.relativo)
# 
# 
# atos.legis.relativo=rbind(rep(1,11) , rep(0,11), atos.legis.relativo)
# # pcol=rgb(0.8,0.2,0.5,0.9) , pfcol=rgb(0.8,0.2,0.5,0.4)
# 
# colors_border=c(rgb(0.7,0.5,0.1,0.9) , rgb(0.7,0.5,0.1,0.9))
# colors_in=c( rgb(0.7,0.5,0.1,0.4) , rgb(0.7,0.5,0.1,0.9))
# 
# par(mar=c(3,0,3,0))
#     par(mfrow=c(1,3))
# 
#   for(i in 3:nrow(atos.legis.relativo)){ 
#     atual.vereador = atos.legis.relativo[c(1,2,i), -1]
#     atual.vereador = rbind(atual.vereador, rep(0,11))
#     
#     radarchart(atual.vereador, axistype=1,
#                pcol=colors_border , pfcol=colors_in, plwd=1, pty=c(16,32), plty=1,
#                 axislabcol="grey" , caxislabels=seq(0,100,25), cglcol = "grey80", cglty=1, cglwd=0.8,
#                 title =  atos.legis.relativo$Vereador[i], vlcex=0.8 )
#   }
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
atos.denomina.legislativo = epv %>% 
  subset(tipo_ato == "Legislativo" & grepl("DENOMINA DE.*RUA|CONCEDE MEDALHA|TÍTULO DE CID", title)) %>%
  mutate(nome_urna_candidato = sapply(nome_urna_candidato, simpleCap)) %>% 
  left_join(select(vereadores, nome_urna_candidato),
            by = c("nome_urna_candidato")) %>% 
  rename(Vereador = nome_urna_candidato) %>% 
  group_by(Vereador) %>% 
  summarise(Administração = as.numeric(sum(main_theme == "administração")), 
            Agricultura = as.numeric(sum(main_theme == "agricultura")), 
            `Assistência Social` = as.numeric(sum(main_theme == "assistencia social")),
            `Educação e Cultura` = as.numeric(sum(main_theme == "educação e cultura")),
            `Gestão e Finanças` = as.numeric(sum(main_theme == "gestão e finanças")),
            Mobilidade = as.numeric(sum(main_theme == "mobilidade")),
            `Obras e Infr. Física` = as.numeric(sum(main_theme == "obras e infraestrutura física")),
            Saúde = as.numeric(sum(main_theme == "saúde")),
            `Segurança e Meio Amb.` = as.numeric(sum(main_theme == "segurança e meio ambiente")),
            Outros = as.numeric(sum(main_theme == "outros")))

nmt = data.frame(Vereador=atos.denomina.legislativo$Vereador, n=rowSums(atos.denomina.legislativo[,2:NCOL(atos.denomina.legislativo)]))

p = hchart(nmt, "column", hcaes(x = Vereador, y = n))
p
```
